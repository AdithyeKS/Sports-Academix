<?php
// File: admin.php
session_start();

// --- PREVENT BROWSER CACHING (SECURITY ADDITION) ---
header("Cache-Control: no-cache, no-store, must-revalidate, max-age=0");
header("Pragma: no-cache");
header("Expires: 0");

// --- SESSION CHECK ---
// Redirects to login page if the user is not logged in.
if (!isset($_SESSION['loggedin'])) {
    header('Location: log.php');
    exit();
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Management System - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* This CSS provides the complete styling for the dashboard. */
        body {
                background-color: #f3f4f6;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                margin: 0;
                color: #1f2937
        }

        .h-screen {
                height: 100vh
        }

        .flex {
                display: flex
        }

        .flex-col {
                flex-direction: column
        }

        .flex-1 {
                flex: 1 1 0%
        }

        .flex-shrink-0 {
                flex-shrink: 0
        }

        .overflow-hidden {
                overflow: hidden
        }

        .overflow-y-auto {
                overflow-y: auto
        }

        .overflow-x-auto {
                overflow-x: auto
        }

        .h-full {
                height: 100%
        }

        .p-4 {
                padding: 1rem
        }

        .p-6 {
                padding: 1.5rem
        }

        .px-2 {
                padding-left: .5rem;
                padding-right: .5rem
        }

        .py-1 {
                padding-top: .25rem;
                padding-bottom: .25rem
        }

        .px-3 {
                padding-left: .75rem;
                padding-right: .75rem
        }

        .py-2 {
                padding-top: .5rem;
                padding-bottom: .5rem
        }

        .px-4 {
                padding-left: 1rem;
                padding-right: 1rem
        }

        .py-3 {
                padding-top: .75rem;
                padding-bottom: .75rem
        }

        .px-6 {
                padding-left: 1.5rem;
                padding-right: 1.5rem
        }

        .py-4 {
                padding-top: 1rem;
                padding-bottom: 1rem
        }

        .mt-1 {
                margin-top: .25rem
        }

        .mr-2 {
                margin-right: .5rem
        }

        .mb-2 {
                margin-bottom: .5rem
        }

        .mr-3 {
                margin-right: .75rem
        }

        .mr-4 {
                margin-right: 1rem
        }

        .mt-4 {
                margin-top: 1rem
        }

        .mb-4 {
                margin-bottom: 1rem
        }

        .mt-6 {
                margin-top: 1.5rem
        }

        .mb-6 {
                margin-bottom: 1.5rem
        }

        .mb-8 {
                margin-bottom: 2rem
        }

        .mt-auto {
                margin-top: auto
        }

        .space-x-2>*:not(:first-child) {
                margin-left: .5rem
        }

        .space-x-4>*:not(:first-child) {
                margin-left: 1rem
        }

        .space-y-4>*:not(:first-child) {
                margin-top: 1rem
        }

        .gap-4 {
                gap: 1rem
        }

        .gap-6 {
                gap: 1.5rem
        }

        .items-center {
                align-items: center
        }

        .items-start {
                align-items: flex-start
        }

        .justify-between {
                justify-content: space-between
        }

        .grid {
                display: grid
        }

        .grid-cols-1 {
                grid-template-columns: repeat(1, minmax(0, 1fr))
        }

        .grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr))
        }

        @media (min-width:768px) {
                .md\:grid-cols-2 {
                        grid-template-columns: repeat(2, minmax(0, 1fr))
                }
        }

        @media (min-width:1024px) {
                .lg\:grid-cols-2 {
                        grid-template-columns: repeat(2, minmax(0, 1fr))
                }

                .lg\:grid-cols-4 {
                        grid-template-columns: repeat(4, minmax(0, 1fr))
                }
        }

        .w-10 {
                width: 2.5rem
        }

        .h-10 {
                height: 2.5rem
        }

        .w-16 {
                width: 4rem
        }

        .h-16 {
                height: 4rem
        }

        .w-64 {
                width: 16rem
        }

        .min-w-full {
                min-width: 100%
        }

        .text-xs {
                font-size: .75rem
        }

        .text-sm {
                font-size: .875rem
        }

        .text-lg {
                font-size: 1.125rem
        }

        .text-xl {
                font-size: 1.25rem
        }

        .text-2xl {
                font-size: 1.5rem
        }

        .text-3xl {
                font-size: 1.875rem
        }

        .font-bold {
                font-weight: 700
        }

        .font-semibold {
                font-weight: 600
        }

        .font-medium {
                font-weight: 500
        }

        .uppercase {
                text-transform: uppercase
        }

        .tracking-wider {
                letter-spacing: .05em
        }

        .text-left {
                text-align: left
        }

        .text-center {
                text-align: center
        }

        .text-right {
                text-align: right
        }

        .whitespace-nowrap {
                white-space: nowrap
        }

        .bg-black {
                background-color: #000
        }

        .bg-white {
                background-color: #fff
        }

        .bg-gray-50 {
                background-color: #f9fafb
        }

        .bg-blue-50 {
                background-color: #eff6ff
        }

        .bg-blue-100 {
                background-color: #dbeafe
        }

        .bg-blue-600 {
                background-color: #2563eb
        }

        .bg-blue-900 {
                background-color: #1e3a8a
        }

        .bg-green-50 {
                background-color: #f0fdf4
        }

        .bg-green-100 {
                background-color: #dcfce7
        }

        .bg-green-500 {
                background-color: #22c55e
        }

        .bg-green-600 {
                background-color: #16a34a
        }

        .bg-purple-50 {
                background-color: #faf5ff
        }

        .bg-purple-100 {
                background-color: #f3e8ff
        }

        .bg-yellow-50 {
                background-color: #fefce8
        }

        .bg-yellow-100 {
                background-color: #fef08a
        }

        .bg-red-100 {
                background-color: #fee2e2
        }

        .bg-red-500 {
                background-color: #ef4444
        }

        .bg-red-600 {
                background-color: #dc2626
        }

        .bg-gray-100 {
                background-color: #f3f4f6
        }

        .text-white {
                color: #fff
        }

        .text-gray-500 {
                color: #6b7281
        }

        .text-gray-600 {
                color: #4b5563
        }

        .text-gray-800 {
                color: #1f2937
        }

        .text-blue-500 {
                color: #3b82f6
        }

        .text-blue-800 {
                color: #1e40af
        }

        .text-green-600 {
                color: #16a34a
        }

        .text-green-800 {
                color: #166534
        }

        .text-purple-800 {
                color: #5b21b6
        }

        .text-yellow-800 {
                color: #854d0e
        }

        .text-red-600 {
                color: #dc2626
        }

        .text-red-800 {
                color: #991b1b
        }

        .rounded-md {
                border-radius: .375rem
        }

        .rounded-lg {
                border-radius: .5rem
        }

        .rounded-full {
                border-radius: 9999px
        }

        .shadow {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1), 0 2px 4px -2px rgba(0, 0, 0, .1)
        }

        .shadow-sm {
                box-shadow: 0 1px 2px 0 rgba(0, 0, 0, .05)
        }

        .divide-y>*:not(:first-child) {
                border-top: 1px solid #e5e7eb
        }

        .cursor-pointer {
                cursor: pointer
        }

        .transition {
                transition: all .15s ease-in-out
        }

        .hover\:bg-blue-700:hover {
                background-color: #1d4ed8
        }

        .hover\:bg-blue-100:hover {
                background-color: #dbeafe
        }

        .hover\:bg-green-100:hover {
                background-color: #dcfce7
        }

        .hover\:bg-purple-100:hover {
                background-color: #f3e8ff
        }

        .hover\:bg-yellow-100:hover {
                background-color: #fef08a
        }

        .hover\:bg-red-700:hover {
                background-color: #b91c1c
        }

        .hover\:text-blue-900:hover {
                color: #1e3a8a
        }

        .hover\:text-red-900:hover {
                color: #7f1d1d
        }

        .sidebar {
                transition: all .3s ease-in-out
        }

        .dashboard-card {
                transition: all .3s ease-in-out
        }

        .dashboard-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, .1)
        }

        .tab-content {
                display: none
        }

        .tab-content.active {
                display: block;
                animation: fadeIn .5s ease-in-out
        }

        @keyframes fadeIn {
                from {
                        opacity: 0;
                        transform: translateY(10px)
                }

                to {
                        opacity: 1;
                        transform: translateY(0)
                }
        }

        .modal-hidden {
                display: none
        }

        .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, .5);
                z-index: 999
        }

        .modal-container {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #fff;
                padding: 1.5rem;
                border-radius: .5rem;
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, .1);
                z-index: 1000;
                width: 90%;
                max-width: 600px;
                max-height: 90vh;
                overflow-y: auto
        }

        .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #e5e7eb;
                padding-bottom: 1rem;
                margin-bottom: 1rem
        }

        .modal-header .close-btn {
                font-size: 1.5rem;
                font-weight: 700;
                line-height: 1;
                border: none;
                background: none;
                cursor: pointer
        }

        .modal-body form label {
                display: block;
                margin-bottom: .5rem;
                font-weight: 600;
                color: #374151
        }

        .modal-body form input,
        .modal-body form select,
        .modal-body form textarea {
                width: 100%;
                box-sizing: border-box;
                padding: .5rem .75rem;
                border: 1px solid #d1d5db;
                border-radius: .375rem;
                margin-bottom: 1rem
        }

        .modal-body form button[type=submit] {
                width: 100%;
                padding: .75rem;
                border-radius: .375rem;
                color: #fff;
                background-color: #2563eb;
                cursor: pointer;
                font-weight: 600;
                transition: background-color .2s
        }

        .modal-body form button[type=submit]:hover {
                background-color: #1d4ed8
        }
        
        a.logout-link {
                display: block;
                text-decoration: none;
                color: white;
        }    
    </style>
</head>
<body>
    <div class="flex h-screen">
        <!-- Sidebar Navigation -->
        <div class="sidebar w-64 bg-black text-white p-4 flex flex-col flex-shrink-0">
            <div class="p-4 flex items-center space-x-2">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iIzFlM2E4YSIvPjxwYXRoIGQ9Ik0zMCA3MEw1MCAzMGwzMCA0MEg3MGwtMjAtMjAtMjAgMjBIMzBaIiBmaWxsPSIjZmZmIi8+PC9zdmc+" alt="Logo" class="w-16 h-16">
                <h1 class="text-xl font-bold">Sports Academix</h1>
            </div>
            <nav class="mt-6 flex flex-col flex-1">
                <div>
                    <div class="px-4 py-3 rounded-md bg-blue-900 cursor-pointer tab-button" data-tab="dashboard"><i class="fas fa-tachometer-alt fa-fw mr-2"></i> Dashboard</div>
                    <div class="px-4 py-3 rounded-md hover:bg-blue-700 cursor-pointer tab-button" data-tab="users"><i class="fas fa-users fa-fw mr-2"></i> User Management</div>
                    <div class="px-4 py-3 rounded-md hover:bg-blue-700 cursor-pointer tab-button" data-tab="departments"><i class="fas fa-building fa-fw mr-2"></i> Department Mngmt</div>
                    <div class="px-4 py-3 rounded-md hover:bg-blue-700 cursor-pointer tab-button" data-tab="sports"><i class="fas fa-futbol fa-fw mr-2"></i> Sports Management</div>
                    <div class="px-4 py-3 rounded-md hover:bg-blue-700 cursor-pointer tab-button" data-tab="events"><i class="fas fa-calendar-alt fa-fw mr-2"></i> Event Management</div>
                    <div class="px-4 py-3 rounded-md hover:bg-blue-700 cursor-pointer tab-button" data-tab="upcoming"><i class="fas fa-calendar-check fa-fw mr-2"></i> Upcoming Matches</div>
                    <div class="px-4 py-3 rounded-md hover:bg-blue-700 cursor-pointer tab-button" data-tab="registrations"><i class="fas fa-clipboard-list fa-fw mr-2"></i> Registrations</div>
                    <div class="px-4 py-3 rounded-md hover:bg-blue-700 cursor-pointer tab-button" data-tab="teams"><i class="fas fa-people-group fa-fw mr-2"></i> Team Management</div>
                    <div class="px-4 py-3 rounded-md hover:bg-blue-700 cursor-pointer tab-button" data-tab="scores"><i class="fas fa-star fa-fw mr-2"></i> Score Management</div>
                    <div class="px-4 py-3 rounded-md hover:bg-blue-700 cursor-pointer tab-button" data-tab="feedback"><i class="fas fa-comments fa-fw mr-2"></i> User Feedback</div>
                </div>
                <a href="logout.php" class="logout-link mt-auto px-4 py-3 rounded-md hover:bg-red-700 cursor-pointer transition"><i class="fas fa-sign-out-alt fa-fw mr-2"></i><span>Logout</span></a>
            </nav>
        </div>
        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm p-4 flex justify-between items-center">
                <h2 class="text-2xl font-semibold text-gray-800" id="page-title">Dashboard</h2>
                <div class="flex items-center space-x-4"><span>Admin</span></div>
            </header>
            <main class="flex-1 overflow-y-auto p-6">
                
                <div id="dashboard" class="tab-content active">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="dashboard-card bg-white rounded-lg shadow p-6 flex justify-between items-center"><div><h3 class="text-gray-500 text-sm">Total Users</h3><p id="totalUsersStat" class="text-3xl font-bold">0</p></div><i class="fas fa-users text-blue-500 text-3xl"></i></div>
                        <div class="dashboard-card bg-white rounded-lg shadow p-6 flex justify-between items-center"><div><h3 class="text-gray-500 text-sm">Active Sports</h3><p id="activeSportsStat" class="text-3xl font-bold">0</p></div><i class="fas fa-futbol text-green-500 text-3xl"></i></div>
                        <div class="dashboard-card bg-white rounded-lg shadow p-6 flex justify-between items-center"><div><h3 class="text-gray-500 text-sm">Upcoming Events</h3><p id="upcomingEventsStat" class="text-3xl font-bold">0</p></div><i class="fas fa-calendar-alt text-purple-500 text-3xl"></i></div>
                        <div class="dashboard-card bg-white rounded-lg shadow p-6 flex justify-between items-center"><div><h3 class="text-gray-500 text-sm">Pending Registrations</h3><p id="pendingRegsStat" class="text-3xl font-bold">0</p></div><i class="fas fa-clipboard-list text-yellow-500 text-3xl"></i></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Available Sports</h3>
                            <div id="dashboardSportsContainer" class="space-y-2"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <button data-tab-link="sports" class="p-4 bg-blue-50 text-blue-800 rounded-lg hover:bg-blue-100 transition flex flex-col items-center"><i class="fas fa-plus-circle text-2xl mb-2"></i><span>Add New Sport</span></button>
                                <button data-tab-link="events" class="p-4 bg-green-50 text-green-800 rounded-lg hover:bg-green-100 transition flex flex-col items-center"><i class="fas fa-calendar-plus text-2xl mb-2"></i><span>Create Event</span></button>
                                <button data-tab-link="teams" class="p-4 bg-purple-50 text-purple-800 rounded-lg hover:bg-purple-100 transition flex flex-col items-center"><i class="fas fa-users text-2xl mb-2"></i><span>Manage Teams</span></button>
                                <button data-tab-link="registrations" class="p-4 bg-yellow-50 text-yellow-800 rounded-lg hover:bg-yellow-100 transition flex flex-col items-center"><i class="fas fa-clipboard-check text-2xl mb-2"></i><span>Review Registrations</span></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="users" class="tab-content"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold">User Management</h2></div><div class="bg-white rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody id="usersTableBody" class="divide-y divide-gray-200"></tbody></table></div></div>
                
                <div id="departments" class="tab-content"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold">Department Management</h2><button id="addDepartmentBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-plus mr-2"></i> Add Department</button></div><div class="bg-white rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody id="departmentsTableBody" class="divide-y divide-gray-200"></tbody></table></div></div>

                <div id="sports" class="tab-content"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold">Sports Management</h2><button id="addSportBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-plus mr-2"></i> Add Sport</button></div><div class="bg-white rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sport Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max Players</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Points (W/D/L)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody id="sportsTableBody" class="divide-y divide-gray-200"></tbody></table></div></div>
                
                <div id="events" class="tab-content"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold">Event Management</h2><button id="addEventBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-calendar-plus mr-2"></i> Create Event</button></div><div class="bg-white rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sport</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teams</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody id="eventsTableBody" class="divide-y divide-gray-200"></tbody></table></div></div>
                
                <div id="upcoming" class="tab-content"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold">Upcoming Match Management</h2></div><div class="bg-white rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sport</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teams</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Venue</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody id="upcomingTableBody" class="divide-y divide-gray-200"></tbody></table></div></div>
                
                <div id="registrations" class="tab-content"><h2 class="text-xl font-semibold mb-6">Pending Registrations</h2><div class="bg-white rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registration For</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sport</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registered At</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody id="registrationsTableBody" class="divide-y divide-gray-200"></tbody></table></div></div>
                
                <div id="teams" class="tab-content"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold">Team Management</h2><button id="addTeamBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-plus mr-2"></i> Create Team</button></div><div class="bg-white rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Team Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sport</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created By</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Players</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody id="teamsTableBody" class="divide-y divide-gray-200"></tbody></table></div></div>
                
                <div id="scores" class="tab-content"><h2 class="text-xl font-semibold mb-6">Score Management</h2><div class="bg-white rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Match</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody id="scoresTableBody" class="divide-y divide-gray-200"></tbody></table></div></div>
                
                <div id="feedback" class="tab-content"><h2 class="text-xl font-semibold mb-6">User Feedback</h2><div id="feedbackContainer" class="space-y-4"></div></div>

            </main>
        </div>
    </div>
    <div id="mainModal" class="modal-hidden"><div class="modal-overlay"></div><div class="modal-container"><div class="modal-header"><h3 id="modalTitle" class="text-xl font-semibold">Modal Title</h3><button id="closeModalBtn" class="close-btn">Ã—</button></div><div id="modalBody" class="modal-body"></div></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let db = { stats: {}, users: [], sports: [], events: [], registrations: [], teams: [], feedback: [], upcomingEvents: [], departments: [] };
        const pageTitle = document.getElementById('page-title');
        const modal = document.getElementById('mainModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const closeModalBtn = document.getElementById('closeModalBtn');
        
        const apiRequest = async (endpoint, action, method = 'GET', body = null) => {
            const url = `api.php?endpoint=${endpoint}&action=${action}`;
            const options = { method, headers: {} };
            if (method !== 'GET' && body) {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }
            try {
                const response = await fetch(url, options);
                const text = await response.text();
                if (!response.ok) {
                    try { const result = JSON.parse(text); throw new Error(result.message || `HTTP error ${response.status}`); }
                    catch (e) { throw new Error(`Server returned non-JSON error: ${response.status}. Check server logs.`); }
                }
                const result = JSON.parse(text);
                if (result.status !== 'success') { throw new Error(result.message || 'An unknown API error occurred'); }
                return result;
            } catch (error) {
                console.error(`API Request Error on ${url}:`, error);
                alert(`API Error: ${error.message}`);
                if (error.message.includes('Unauthorized')) { window.location.reload(); }
                throw error;
            }
        };

        const showAlert = (message, type = 'success') => alert((type === 'error' ? 'Error: ' : 'Success: ') + message);
        const getStatusClass = (status) => { if (!status) return 'bg-gray-100 text-gray-800'; status = status.toLowerCase(); const classes = { 'active': 'bg-green-100 text-green-800', 'ongoing': 'bg-blue-100 text-blue-800', 'scheduled': 'bg-blue-100 text-blue-800', 'approved': 'bg-green-100 text-green-800', 'inactive': 'bg-red-100 text-red-800', 'blocked': 'bg-red-100 text-red-800', 'cancelled': 'bg-red-100 text-red-800', 'rejected': 'bg-red-100 text-red-800', 'pending': 'bg-yellow-100 text-yellow-800', 'postponed': 'bg-yellow-100 text-yellow-800', 'completed': 'bg-gray-100 text-gray-800' }; return classes[status] || 'bg-gray-100 text-gray-800'; };

        const renderTable = (tbodyId, data, rowGenerator, colCount) => {
            const tbody = document.getElementById(tbodyId);
            if (!tbody) return;
            tbody.innerHTML = data && data.length > 0 ? data.map(rowGenerator).join('') : `<tr><td colspan="${colCount}" class="text-center p-4 text-gray-500">No data available.</td></tr>`;
        };
        
        const renderDashboard = () => {
            const stats = db.stats || {};
            document.getElementById('totalUsersStat').textContent = stats.totalUsers || 0;
            document.getElementById('activeSportsStat').textContent = stats.activeSports || 0;
            document.getElementById('upcomingEventsStat').textContent = stats.upcomingEvents || 0;
            document.getElementById('pendingRegsStat').textContent = stats.pendingRegistrations || 0;
            const sportsContainer = document.getElementById('dashboardSportsContainer');
            if (sportsContainer) {
                if (db.sports && db.sports.length > 0) {
                    sportsContainer.innerHTML = db.sports.slice(0, 5).map(sport => `<div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50"><div class="flex items-center"><i class="fas fa-futbol text-gray-400 mr-3 text-xl"></i><p class="font-semibold text-sm text-gray-800">${sport.name}</p></div><span class="px-2 py-1 text-xs rounded-full ${getStatusClass(sport.status)}">${sport.status}</span></div>`).join('');
                    if (db.sports.length > 5) { sportsContainer.innerHTML += `<a href="#" class="text-sm text-blue-600 hover:underline mt-2 block text-center" data-tab-link="sports">View All Sports</a>`; }
                } else { sportsContainer.innerHTML = '<p class="text-sm text-gray-500">No sports have been added yet.</p>'; }
            }
        };

        const renderAllTables = () => {
            renderTable('usersTableBody', db.users, user => `<tr class="hover:bg-gray-50"><td class="px-6 py-4">${user.user_id}</td><td class="px-6 py-4">${user.name}</td><td class="px-6 py-4">${user.email}</td><td class="px-6 py-4">${user.student_id || 'N/A'}</td><td class="px-6 py-4">${user.role}</td><td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full ${getStatusClass(user.status)}">${user.status}</span></td><td class="px-6 py-4"><button class="text-red-600 hover:text-red-900" data-endpoint="users" data-action="delete_user" data-id="${user.user_id}" title="Delete User"><i class="fas fa-trash"></i></button></td></tr>`, 7);
            renderTable('departmentsTableBody', db.departments, dept => `<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-medium">${dept.department_name}</td><td class="px-6 py-4"><button class="text-blue-600 hover:text-blue-900 mr-4" data-action="edit-department" data-id="${dept.department_id}" title="Edit Department"><i class="fas fa-edit"></i></button><button class="text-red-600 hover:text-red-900" data-endpoint="departments" data-action="delete_department" data-id="${dept.department_id}" title="Delete Department"><i class="fas fa-trash"></i></button></td></tr>`, 2);
            renderTable('sportsTableBody', db.sports, sport => `<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-medium">${sport.name}</td><td class="px-6 py-4">${sport.max_players}</td><td class="px-6 py-4 font-semibold">${sport.points_for_win} / ${sport.points_for_draw} / ${sport.points_for_loss}</td><td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full ${getStatusClass(sport.status)}">${sport.status}</span></td><td class="px-6 py-4"><button class="text-blue-600 hover:text-blue-900 mr-4" data-action="edit-sport" data-id="${sport.sport_id}" title="Edit Sport"><i class="fas fa-edit"></i></button><button class="text-red-600 hover:text-red-900" data-endpoint="sports" data-action="delete_sport" data-id="${sport.sport_id}" title="Delete Sport"><i class="fas fa-trash"></i></button></td></tr>`, 5);
            renderTable('eventsTableBody', db.events, event => `<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-medium">${event.event_name}</td><td class="px-6 py-4">${event.sport_name}</td><td class="px-6 py-4 whitespace-nowrap">${new Date(event.event_date).toLocaleString()}</td><td class="px-6 py-4 text-sm">${event.team1_name || 'N/A'} vs ${event.team2_name || 'N/A'}</td><td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full ${getStatusClass(event.status)}">${event.status}</span></td><td class="px-6 py-4 whitespace-nowrap"><button class="text-blue-600 hover:text-blue-900 mr-4" data-action="edit-event" data-id="${event.event_id}" title="Edit Event"><i class="fas fa-edit"></i></button><button class="text-red-600 hover:text-red-900" data-endpoint="events" data-action="delete_event" data-id="${event.event_id}" title="Delete Event"><i class="fas fa-trash"></i></button></td></tr>`, 6);
            renderTable('upcomingTableBody', db.upcomingEvents, event => `<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-medium">${event.event_name}</td><td class="px-6 py-4">${event.sport_name}</td><td class="px-6 py-4 whitespace-nowrap">${new Date(event.event_date).toLocaleString()}</td><td class="px-6 py-4 text-sm">${event.team1_name || 'N/A'} vs ${event.team2_name || 'N/A'}</td><td class="px-6 py-4">${event.venue}</td><td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full ${getStatusClass(event.status)}">${event.status}</span></td><td class="px-6 py-4 whitespace-nowrap"><button class="text-blue-600 hover:text-blue-900 mr-4" data-action="edit-event" data-id="${event.event_id}" title="Edit Event"><i class="fas fa-edit"></i></button><button class="text-red-600 hover:text-red-900" data-endpoint="events" data-action="delete_event" data-id="${event.event_id}" title="Delete Event"><i class="fas fa-trash"></i></button></td></tr>`, 7);
            renderTable('registrationsTableBody', db.registrations, reg => `<tr class="hover:bg-gray-50"><td class="px-6 py-4">${reg.user_name}</td><td class="px-6 py-4">${reg.registration_detail} <span class="text-xs text-gray-500">(${reg.registration_type})</span></td><td class="px-6 py-4">${reg.sport_name || 'N/A'}</td><td class="px-6 py-4">${new Date(reg.registered_at).toLocaleString()}</td><td class="px-6 py-4"><button class="text-green-600 hover:text-green-900 mr-4" data-endpoint="registrations" data-action="approve_reg" data-id="${reg.registration_id}">Approve</button><button class="text-red-600 hover:text-red-900" data-endpoint="registrations" data-action="reject_reg" data-id="${reg.registration_id}">Reject</button></td></tr>`, 5);
            renderTable('teamsTableBody', db.teams, team => `<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-medium">${team.team_name}</td><td class="px-6 py-4">${team.sport_name}</td><td class="px-6 py-4">${team.creator_name || 'N/A'}</td><td class="px-6 py-4">${team.player_count}</td><td class="px-6 py-4"><button class="text-red-600 hover:text-red-900" data-endpoint="teams" data-action="delete_team" data-id="${team.team_id}" title="Delete Team"><i class="fas fa-trash"></i></button></td></tr>`, 5);
            renderTable('scoresTableBody', db.events, event => `<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-medium">${event.team1_name || 'Team 1'} vs ${event.team2_name || 'Team 2'}<br><span class="text-xs text-gray-500">${event.event_name}</span></td><td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full ${getStatusClass(event.status)}">${event.status}</span></td><td class="px-6 py-4 font-bold text-xl">${event.team1_score} - ${event.team2_score}</td><td class="px-6 py-4">${(event.result || 'pending').replace('_', ' ').replace('team1 win', `${event.team1_name} Wins`).replace('team2 win', `${event.team2_name} Wins`)}</td><td class="px-6 py-4"><button class="bg-blue-600 text-white px-3 py-1 text-sm rounded-md hover:bg-blue-700" data-action="update-score" data-id="${event.event_id}">Update</button></td></tr>`, 5);
            const feedbackContainer = document.getElementById('feedbackContainer'); if(feedbackContainer) feedbackContainer.innerHTML = db.feedback.map(fb => `<div class="shadow rounded-lg p-4 ${fb.is_read == 1 ? 'bg-gray-50' : 'bg-white border-l-4 border-blue-500'}"><div class="flex justify-between items-start"><div><p class="font-bold text-lg">${fb.subject}</p><p class="text-sm text-gray-500">From: ${fb.user_name} (${fb.user_email}) on ${new Date(fb.submitted_at).toLocaleString()}</p></div><div class="flex items-center space-x-4"><button class="${fb.is_read == 1 ? 'text-gray-500 hover:text-gray-800' : 'text-blue-600 hover:text-blue-900'}" data-endpoint="feedback" data-action="toggle_feedback_read" data-id="${fb.feedback_id}" title="${fb.is_read == 1 ? 'Mark as Unread' : 'Mark as Read'}"><i class="fas ${fb.is_read == 1 ? 'fa-eye-slash' : 'fa-eye'}"></i></button><button class="text-red-600 hover:text-red-900" data-endpoint="feedback" data-action="delete_feedback" data-id="${fb.feedback_id}" title="Delete Feedback"><i class="fas fa-trash"></i></button></div></div><div class="mt-4 pt-4 border-t border-gray-200"><p class="text-gray-800">${fb.message.replace(/\n/g, '<br>')}</p></div></div>`).join('');
        };

        const refreshData = async () => {
            try {
                const [dashRes, usersRes, deptsRes, sportsRes, eventsRes, regsRes, teamsRes, feedbackRes, upcomingRes] = await Promise.all([
                    apiRequest('dashboard', 'get_dashboard_data'),
                    apiRequest('users', 'get_users'),
                    apiRequest('departments', 'get_departments'),
                    apiRequest('sports', 'get_sports'),
                    apiRequest('events', 'get_events'),
                    apiRequest('registrations', 'get_pending_registrations'),
                    apiRequest('teams', 'get_teams'),
                    apiRequest('feedback', 'get_feedback'),
                    apiRequest('events', 'get_upcoming_events')
                ]);
                
                db = { stats: dashRes.data.stats, users: usersRes.data, departments: deptsRes.data, sports: sportsRes.data, events: eventsRes.data, registrations: regsRes.data, teams: teamsRes.data, feedback: feedbackRes.data, upcomingEvents: upcomingRes.data };
                renderDashboard();
                renderAllTables();
            } catch (error) {
                document.body.innerHTML = `<div style="padding: 2rem; text-align: center; color: red;"><strong>Fatal Error:</strong> Could not load initial data. Please check the browser console for errors and ensure api.php is working correctly.</div>`;
            }
        };

        const showModal = (title, content) => { modalTitle.textContent = title; modalBody.innerHTML = content; modal.classList.remove('modal-hidden'); };
        const hideModal = () => modal.classList.add('modal-hidden');
        
        const getDepartmentFormHtml = (dept = {}) => `<form id="departmentForm" data-id="${dept.department_id || ''}"><label for="department_name">Department Name</label><input type="text" id="department_name" name="department_name" value="${dept.department_name || ''}" required><button type="submit" class="mt-4">${dept.department_id ? 'Update' : 'Add'} Department</button></form>`;
        const getSportFormHtml = (sport = {}) => `<form id="sportForm" data-id="${sport.sport_id || ''}"><label for="name">Sport Name</label><input type="text" id="name" name="name" value="${sport.name || ''}" required><label for="max_players">Max Players</label><input type="number" id="max_players" name="max_players" value="${sport.max_players || '0'}" required min="1"><div style="display:flex; gap: 1rem;"><div style="flex:1;"><label for="points_for_win">Points for Win</label><input type="number" id="points_for_win" name="points_for_win" value="${sport.points_for_win != null ? sport.points_for_win : '3'}" required></div><div style="flex:1;"><label for="points_for_draw">Points for Draw</label><input type="number" id="points_for_draw" name="points_for_draw" value="${sport.points_for_draw != null ? sport.points_for_draw : '1'}" required></div><div style="flex:1;"><label for="points_for_loss">Points for Loss</label><input type="number" id="points_for_loss" name="points_for_loss" value="${sport.points_for_loss != null ? sport.points_for_loss : '0'}" required></div></div><label for="status">Status</label><select id="status" name="status" required><option value="active" ${sport.status === 'active' ? 'selected' : ''}>Active</option><option value="inactive" ${sport.status === 'inactive' ? 'selected' : ''}>Inactive</option></select><button type="submit" class="mt-4">${sport.sport_id ? 'Update' : 'Add'} Sport</button></form>`;
        const getEventFormHtml = (event = {}, sports = [], teams = []) => { const isEdit = !!event.event_id; const sportOptions = sports.map(s => `<option value="${s.sport_id}" ${s.sport_id == event.sport_id ? 'selected':''}>${s.name}</option>`).join(''); const teamOptions = teams.map(t => `<option value="${t.team_id}" data-sport-id="${t.sport_id}">${t.team_name}</option>`).join(''); const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); const minDateTime = now.toISOString().slice(0, 16); const eventDate = event.event_date ? new Date(new Date(event.event_date).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16) : ''; return `<form id="eventForm" data-id="${isEdit ? event.event_id : ''}"><label for="event_name">Event Name</label><input type="text" id="event_name" name="event_name" value="${event.event_name || ''}" required><label for="sport_id">Sport</label><select id="sport_id" name="sport_id" required><option value="">-- Select Sport --</option>${sportOptions}</select><label for="event_date">Date and Time</label><input type="datetime-local" id="event_date" name="event_date" value="${eventDate}" min="${minDateTime}" required><label for="venue">Venue</label><input type="text" id="venue" name="venue" value="${event.venue || ''}" required><div style="display:flex; gap:1rem;"><div style="flex:1;"><label for="team1_id">Team 1</label><select id="team1_id" name="team1_id" required><option value="">-- Select --</option>${teamOptions}</select></div><div style="flex:1;"><label for="team2_id">Team 2</label><select id="team2_id" name="team2_id" required><option value="">-- Select --</option>${teamOptions}</select></div></div>${isEdit ? `<label for="status">Event Status</label><select id="status" name="status" required><option value="schedule" ${event.status === 'schedule' ? 'selected':''}>Scheduled</option><option value="ongoing" ${event.status === 'ongoing' ? 'selected':''}>Ongoing</option><option value="completed" ${event.status === 'completed' ? 'selected':''}>Completed</option><option value="postponed" ${event.status === 'postponed' ? 'selected':''}>Postponed</option><option value="cancelled" ${event.status === 'cancelled' ? 'selected':''}>Cancelled</option></select>` : ''}<label for="description">Description (Optional)</label><textarea id="description" name="description" rows="3">${event.description || ''}</textarea><button type="submit" class="mt-4">${isEdit ? 'Update' : 'Create'} Event</button></form><script>const sportSelect = document.getElementById('sport_id'); const teamSelects = [document.getElementById('team1_id'), document.getElementById('team2_id')]; function filterTeams() { const selectedSportId = sportSelect.value; teamSelects.forEach(select => { for (const option of select.options) { if (option.value) { option.style.display = (option.dataset.sportId === selectedSportId || !selectedSportId) ? '' : 'none'; } } if (select.options[select.selectedIndex] && select.options[select.selectedIndex].style.display === 'none') { select.value = ''; } }); } sportSelect.addEventListener('change', filterTeams); document.getElementById('team1_id').value = '${event.team1_id || ''}'; document.getElementById('team2_id').value = '${event.team2_id || ''}'; filterTeams();<\/script>`; };
        const getTeamFormHtml = (team = {}, sports = []) => { const sportOptions = sports.filter(s => s.status === 'active').map(s => `<option value="${s.sport_id}" ${s.sport_id == team.sport_id ? 'selected':''}>${s.name}</option>`).join(''); return `<form id="teamForm" data-id="${team.team_id || ''}"><label for="team_name">Team Name</label><input type="text" id="team_name" name="team_name" value="${team.team_name || ''}" required><label for="sport_id">Sport</label><select id="sport_id" name="sport_id" required><option value="">-- Select a Sport --</option>${sportOptions}</select><button type="submit" class="mt-4">${team.team_id ? 'Update' : 'Create'} Team</button></form>`;};
        const getScoreFormHtml = (event = {}) => `<form id="scoreForm" data-id="${event.event_id}"><div style="display:flex; gap:1rem; align-items:center; justify-content:center; text-align:center;"><div style="flex:1;"><label for="team1_score">${event.team1_name || 'Team 1'}</label><input type="number" id="team1_score" name="team1_score" value="${event.team1_score || 0}" required min="0" style="font-size:1.5rem; text-align:center;"></div><div style="font-size:2rem; font-weight:bold;">-</div><div style="flex:1;"><label for="team2_score">${event.team2_name || 'Team 2'}</label><input type="number" id="team2_score" name="team2_score" value="${event.team2_score || 0}" required min="0" style="font-size:1.5rem; text-align:center;"></div></div><p class="text-sm text-center text-gray-500 mt-2 mb-4">Updating the score will automatically mark the event as 'Completed'.</p><button type="submit" class="mt-4">Update Score & Finalize</button></form>`;
        
        function handleTabSwitch(tabId) { pageTitle.textContent = document.querySelector(`.tab-button[data-tab="${tabId}"]`).textContent.trim(); document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active')); document.getElementById(tabId)?.classList.add('active'); document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('bg-blue-900')); document.querySelector(`.tab-button[data-tab="${tabId}"]`)?.classList.add('bg-blue-900'); }
        document.querySelectorAll('.tab-button').forEach(button => button.addEventListener('click', function() { handleTabSwitch(this.dataset.tab); }));
        document.body.addEventListener('click', e => { const ql = e.target.closest('[data-tab-link]'); if(ql) { e.preventDefault(); handleTabSwitch(ql.dataset.tabLink); } });
        
        closeModalBtn.addEventListener('click', hideModal);
        modal.addEventListener('click', e => { if(e.target === modal.querySelector('.modal-overlay')) hideModal(); });
        document.getElementById('addDepartmentBtn').addEventListener('click', () => showModal('Add New Department', getDepartmentFormHtml()));
        document.getElementById('addSportBtn').addEventListener('click', () => showModal('Add New Sport', getSportFormHtml()));
        document.getElementById('addEventBtn').addEventListener('click', () => showModal('Create New Event', getEventFormHtml({}, db.sports, db.teams)));
        document.getElementById('addTeamBtn').addEventListener('click', () => showModal('Create New Team', getTeamFormHtml({}, db.sports)));

        document.body.addEventListener('click', async (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            e.preventDefault();
            const { action, id, endpoint } = button.dataset;
            const recordId = parseInt(id);

            if (endpoint) {
                if (action.startsWith('delete_') && !confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
                    return;
                }
                await apiRequest(endpoint, action, 'POST', { id: recordId });
                refreshData();
            } else if (action === 'edit-department') {
                showModal('Edit Department', getDepartmentFormHtml(db.departments.find(d => d.department_id === recordId)));
            } else if (action === 'edit-sport') {
                showModal('Edit Sport', getSportFormHtml(db.sports.find(s => s.sport_id === recordId)));
            } else if (action === 'edit-event') {
                const eventData = db.events.find(ev => ev.event_id === recordId) || db.upcomingEvents.find(ev => ev.event_id === recordId);
                showModal('Edit Event', getEventFormHtml(eventData, db.sports, db.teams));
            } else if (action === 'update-score') {
                showModal('Update Score', getScoreFormHtml(db.events.find(ev => ev.event_id === recordId)));
            }
        });

        document.body.addEventListener('submit', async (e) => {
            if (!e.target.id) return;
            e.preventDefault();
            const form = e.target;
            const recordId = form.dataset.id ? parseInt(form.dataset.id) : null;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            if (recordId) data.id = recordId;

            let isValid = true;
            let errorMessage = '';

            const fieldsToTrim = ['name', 'team_name', 'event_name', 'venue', 'department_name'];
            for (const fieldName of fieldsToTrim) {
                if (data.hasOwnProperty(fieldName)) {
                    const trimmedValue = data[fieldName].trim();
                    if (form.querySelector(`[name=${fieldName}]`).hasAttribute('required') && trimmedValue === '') {
                        isValid = false;
                        const prettyFieldName = fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        errorMessage = `${prettyFieldName} cannot be empty or just spaces.`;
                        break;
                    }
                    data[fieldName] = trimmedValue;
                }
            }

            if (isValid && form.id === 'eventForm') {
                if (data.team1_id && data.team2_id && data.team1_id === data.team2_id) {
                    isValid = false;
                    errorMessage = 'Team 1 and Team 2 cannot be the same.';
                }
            }
            
            if (!isValid) { showAlert(errorMessage, 'error'); return; }

            let endpoint, action;
            switch(form.id) {
                case 'departmentForm': endpoint = 'departments'; action = recordId ? 'update_department' : 'add_department'; break;
                case 'sportForm': endpoint = 'sports'; action = recordId ? 'update_sport' : 'add_sport'; break;
                case 'eventForm': endpoint = 'events'; action = recordId ? 'update_event' : 'add_event'; break;
                case 'scoreForm': endpoint = 'events'; action = 'update_score'; break;
                case 'teamForm':  endpoint = 'teams'; action = recordId ? 'update_team' : 'add_team'; break;
            }

            if (endpoint && action) {
                try {
                    const result = await apiRequest(endpoint, action, 'POST', data);
                    showAlert(result.message);
                    hideModal();
                    refreshData();
                } catch(error) { /* handled by apiRequest */ }
            }
        });

        refreshData();
    });
    </script>
</body>
</html>